<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AgentsChat 实时 UI</title>
  <style>
    :root {
      color-scheme: light;
      font-family: "PingFang SC", "Noto Sans SC", "Microsoft YaHei", sans-serif;
      background: #f5f7fb;
    }

    body {
      margin: 0;
      padding: 24px 0 48px;
      display: flex;
      justify-content: center;
      background: #f5f7fb;
    }

    .app {
      width: min(1100px, 94vw);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    header {
      background: #ffffff;
      border-radius: 20px;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.06);
    }

    header .title {
      font-weight: 600;
      color: #0f172a;
    }

    header .controls {
      display: flex;
      gap: 12px;
      align-items: center;
      font-size: 13px;
      color: #475569;
    }

    select {
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      padding: 6px 10px;
      background: #ffffff;
      color: #0f172a;
    }

    .status {
      font-size: 12px;
      color: #94a3b8;
    }

    .chat-shell {
      background: #ffffff;
      border-radius: 24px;
      padding: 28px 24px 36px;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .message-row {
      display: flex;
      gap: 14px;
      align-items: flex-start;
    }

    .message-row.is-self {
      flex-direction: row-reverse;
    }

    .avatar {
      width: 52px;
      height: 52px;
      border-radius: 8px;
      background: #1f2937;
      color: #f9fafb;
      display: grid;
      place-items: center;
      font-weight: 600;
      font-size: 12px;
      line-height: 1.1;
      padding: 4px;
      text-align: center;
      word-break: break-word;
      white-space: normal;
      flex-shrink: 0;
    }

    .message-stack {
      display: flex;
      flex-direction: column;
    }

    .bubble {
      background: #f0f4ff;
      border-radius: 16px 16px 16px 6px;
      padding: 14px 18px;
      max-width: 72%;
      line-height: 1.6;
      font-size: 16px;
      color: #0f172a;
      box-shadow: 0 8px 16px rgba(15, 23, 42, 0.05);
    }

    .bubble.is-self {
      background: #dff7e5;
      border-radius: 16px 16px 6px 16px;
      margin-left: auto;
    }

    .bubble.drafting {
      font-style: italic;
      color: #475569;
    }

    .meta {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 6px;
    }

    .meta span + span::before {
      content: "•";
      margin: 0 6px;
    }

    .notice {
      align-self: center;
      background: #94a3b8;
      color: #ffffff;
      padding: 6px 18px;
      border-radius: 999px;
      font-size: 13px;
      letter-spacing: 0.2px;
    }

    .empty {
      text-align: center;
      color: #94a3b8;
      font-size: 14px;
      padding: 32px 0;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <div class="title">AgentsChat 实时 UI</div>
        <div class="status" id="connection-status">等待数据...</div>
      </div>
      <div class="controls">
        <label>
          Session:
          <select id="session-select"></select>
        </label>
        <span>自动刷新 2s</span>
      </div>
    </header>

    <main class="chat-shell" id="chat-shell">
      <div class="empty" id="empty-state">暂无事件，等待运行中产生数据...</div>
    </main>
  </div>

  <script>
    const chatShell = document.getElementById("chat-shell");
    const emptyState = document.getElementById("empty-state");
    const sessionSelect = document.getElementById("session-select");
    const statusLabel = document.getElementById("connection-status");
    const draftingTexts = [
      "正在草拟意向...",
      "正在组织语言...",
      "正在检查引用...",
      "正在合并信息...",
      "即将发送..."
    ];
    let draftingIndex = 0;

    function pickAvatar(name) {
      if (!name) return "?";
      return name.trim();
    }

    function formatContent(event) {
      const content = event.content || {};
      if (typeof content.text === "string") return content.text;
      if (typeof content.request === "string") return content.request;
      if (typeof content.message === "string") return content.message;
      return JSON.stringify(content, null, 2);
    }

    function formatReferences(event) {
      const refs = Array.isArray(event.references) ? event.references : [];
      if (refs.length === 0) {
        return [{ id: "-", weight: "0" }];
      }
            return refs.map((ref) => {
        const weight = ref.weight || {};
        const weightKeys = Object.keys(weight);
        if (weightKeys.length === 0) {
          return { id: ref.event_id || "-", weight: "0" };
        }
        const summary = weightKeys
          .map((key) => `${key}:${weight[key]}`)
          .join(" ");
        return { id: ref.event_id || "-", weight: summary };
      });
    }

    function isNotice(event) {
      return event.type === "notice" || (event.metadata && event.metadata.notice);
    }

    function clearChat() {
      while (chatShell.firstChild) {
        chatShell.removeChild(chatShell.firstChild);
      }
    }

    function renderEvents(events) {
      clearChat();
      if (!events.length) {
        emptyState.style.display = "block";
        chatShell.appendChild(emptyState);
        return;
      }
      emptyState.style.display = "none";

      const latestDraftingIndex = events.reduce((latestIndex, event, index) => {
        if (isNotice(event)) {
          return latestIndex;
        }
        return event.completed === false ? index : latestIndex;
      }, -1);

      events.forEach((event, index) => {
        if (isNotice(event)) {
          const notice = document.createElement("div");
          notice.className = "notice";
          notice.textContent = formatContent(event);
          chatShell.appendChild(notice);
          return;
        }

        const row = document.createElement("div");
        row.className = "message-row";
        const sender = event.sender || "";
        const senderName = event.sender_name || sender;
        if (sender === "you" || sender === "self") {
          row.classList.add("is-self");
        }

        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.textContent = pickAvatar(senderName || "?");

        const stack = document.createElement("div");
        stack.className = "message-stack";

        const bubble = document.createElement("div");
        bubble.className = "bubble";

        const isDrafting = index === latestDraftingIndex;
        if (isDrafting) {
          bubble.classList.add("drafting");
          bubble.dataset.drafting = "true";
          bubble.textContent = draftingTexts[draftingIndex % draftingTexts.length];
        } else {
          bubble.textContent = formatContent(event);
        }

        if (row.classList.contains("is-self")) {
          bubble.classList.add("is-self");
        }

        const meta = document.createElement("div");
        meta.className = "meta";
        const references = formatReferences(event);
        const typeLabel = event.type || "-";
        meta.innerHTML = `<div>事件 ID: ${event.event_id || "-"} 类型 ${typeLabel}</div>` +
          references
            .map((reference) => (
              `<div>引用: ${reference.id} 权重: ${reference.weight}</div>`
            ))
            .join("");

        stack.appendChild(bubble);
        stack.appendChild(meta);
        row.appendChild(avatar);
        row.appendChild(stack);
        chatShell.appendChild(row);
      });
    }

    async function loadSessions() {
      const response = await fetch("/api/sessions");
      const data = await response.json();
      const sessions = data.sessions || [];
      const current = sessionSelect.value || data.latest || "";

      sessionSelect.innerHTML = "";
      sessions.forEach((session) => {
        const option = document.createElement("option");
        option.value = session.session_id;
        option.textContent = session.session_id;
        if (session.session_id === current) {
          option.selected = true;
        }
        sessionSelect.appendChild(option);
      });

      if (!sessionSelect.value && current) {
        const fallback = document.createElement("option");
        fallback.value = current;
        fallback.textContent = current;
        fallback.selected = true;
        sessionSelect.appendChild(fallback);
      }
    }

    async function loadEvents() {
      const session = sessionSelect.value;
      if (!session) {
        renderEvents([]);
        statusLabel.textContent = "未找到 session";
        return;
      }
      statusLabel.textContent = "正在刷新...";
      const response = await fetch(`/api/events?session=${encodeURIComponent(session)}&limit=200`);
      const data = await response.json();
      renderEvents(data.events || []);
      const now = new Date();
      statusLabel.textContent = `最新刷新 ${now.toLocaleTimeString()}`;
    }

    function rotateDrafting() {
      draftingIndex += 1;
      const draftingNodes = document.querySelectorAll("[data-drafting='true']");
      const latestNode = draftingNodes[draftingNodes.length - 1];
      if (latestNode) {
        latestNode.textContent = draftingTexts[draftingIndex % draftingTexts.length];
      }
    }

    sessionSelect.addEventListener("change", () => {
      loadEvents();
    });

    async function boot() {
      await loadSessions();
      await loadEvents();
      setInterval(loadEvents, 2000);
      setInterval(rotateDrafting, 1800);
    }

    boot();
  </script>
</body>
</html>