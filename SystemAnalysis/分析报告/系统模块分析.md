# 系统模块分析（SystemAnalysis/系统模块分析.md）

> 目标：把“这个系统到底由哪些模块组成、各自干啥”讲清楚。  
> 风格：通俗、好懂、可拿去给新人做 onboarding。

---

## 1. 总体架构：一个“事件驱动的多智能体闭环”
**一句话总结：**
系统像一个“群聊 + 裁判 + 快递员”。
- **Agent** 在群里说话（先写意向 Intention）。
- **Interpreter** 当裁判，决定这话能不能说。
- **Router** 当快递员，把通过的意向变成事件 Event 并广播给全世界。
- **World** 就是群聊场景本身，负责广播与记录。

闭环顺序：
```
事件 Event
  ↓
意向 Intention（Agent 提案）
  ↓
Interpreter 审核
  ↓
Router 转成 Event
  ↓
World 广播 → 进入下一轮
```

---

## 2. 目录层面的模块划分（结构清晰、分层专业）
从目录看就是典型的“分层式系统”：

- **agents/**：Agent 行为、提案、解释器（智能体大脑层）
- **platform/**：世界、路由器、观察者（系统环境层）
- **events/**：事件/意向数据结构 + 存储（数据模型层）
- **runtime/**：运行时装配 + 主循环（执行引擎层）
- **llm/**：LLM 客户端、prompt、schema（智能插件层）
- **ui/**：可视化监控（可视化层）

你可以把它理解为：
“agents 决定说什么；events 负责记录；platform 决定怎么广播；runtime 控制节奏；llm 提供大脑外挂；ui 负责让人类看见。”

---

## 3. 核心模块详解（逐个拆解）

### 3.1 Agent 系统（agents/）
**角色：系统里最小的“社会行动者”。**
- Agent 只负责“表达意向”，不负责解释意向。
- 它能说话、发起请求、提交结果。
- 重点是“显式声明”，而不是“暗箱推理”。

可理解为：Agent 像是群里发言的人，先起草发言计划，系统再决定能不能发出去。

### 3.2 Interpreter（意向审查器）
**角色：裁判。**
- 通过 YAML 规则，检查意向是否允许。
- 负责 forbid/require 等“硬性约束”。
- 未来可以扩展为 rewrite/downgrade（自动修正或降级）。

### 3.3 Router（路由器）
**角色：快递员。**
- 把意向转成事件。
- 负责写入 EventStore 并广播给 World。
- 还带节流（CooldownGuard），防止刷屏。

### 3.4 World（世界）
**角色：群聊场景 + 事件时间线。**
- 记录所有事件。
- 按 scope（public / group）决定谁能看到。
- 广播给观察者（Agent、Controller、UI、RequestTracker）。

### 3.5 Runtime（运行时）
**角色：引擎。**
- 负责装配所有模块。
- 负责主循环 tick 执行。
- 定义 session 存储与日志策略。

### 3.6 LLM 模块（llm/）
**角色：智能外挂。**
- 提供 OpenAI 兼容 client。
- 使用 prompt + schema 约束 LLM 输出。
- 用于 draft 意向生成 + final 意向生成。

### 3.7 UI（ui/）
**角色：监控屏。**
- 目前只是“实时刷事件列表”的 Live UI。
- 可视化程度较低，但足够用于调试与观察。

---

## 4. 模块之间的“人话版协作关系”

### 一个事件从出现到闭环的流程：
1. **World 收到 Event** → 广播给 Controller/Agent 观察者。
2. **Controller** 根据事件挑选 Agent。
3. **Agent（通过 Proposer）** 生成 Draft Intention。
4. **Finalizer** 把 Draft 意向补齐引用与权重。
5. **Interpreter** 检查意向是否合法。
6. **Router** 转换并投递 Event → 回到 World。

一句话：
**“World 报事件 → Agent 想回应 → Interpreter 审核 → Router 广播 → World 继续通知。”**

---

## 5. 模块成熟度评分（带点吐槽）

| 模块 | 成熟度 | 评价 |
|------|--------|------|
| agents | ⭐⭐⭐ | 结构清晰，但规则脑为主 |
| events | ⭐⭐⭐⭐ | 数据结构完整，闭环清晰 |
| platform | ⭐⭐⭐⭐ | 路由/世界逻辑合理 |
| runtime | ⭐⭐⭐⭐ | 装配与循环足够稳定 |
| llm | ⭐⭐ | 客户端齐全但未深度集成 |
| ui | ⭐⭐ | 监控可用但较朴素 |
| policies | ⭐⭐⭐ | 基础约束已成型，深度不足 |

---

## 6. 结论（给人看的版本）
- 这是一个“底座很稳”的系统，已经能跑通闭环。  
- 但智能层还比较“婴儿”，需要喂饱 LLM 和检索机制。  
- 目前更适合作为“实验平台/学术沙盒”，而不是直接上线的产品。

如果要加戏：
> 这是一个刚搭好舞台的剧院，灯光有了、座椅有了、舞台经理就位了，但演员的台词本还没写完。  
> 下一步就是：给演员（Agent）更多智力与稳定性。

