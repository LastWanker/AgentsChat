# 数据流向分析（SystemAnalysis/数据流向分析.md）

> 目标：把“数据在系统里怎么走”讲成一条清晰的流水线。

---

## 1. 核心数据类型：意向（Intention）与事件（Event）
- **Intention**：Agent 的“意愿草稿”，是“我想干什么”的声明。
- **Event**：系统世界里的“事实记录”，是“真的发生了什么”。

一句话理解：
> 意向是“想做的事”，事件是“已经发生的事”。

---

## 2. 数据流主线：一条“事件闭环传送带”

### Step 1：种子事件进入系统
- 入口通常由 `main.py` 生成种子事件，例如 `request_anyone`。
- 事件被写入 EventStore，再广播到 World。

### Step 2：World 广播事件
- World 按 scope（public/group）判断谁能看到事件。
- Controller 和各 Agent 作为观察者，会收到事件。

### Step 3：Controller 触发“意向草稿”
- Controller 选择可响应的 Agent。
- 对 Agent 调用 Proposer，生成 `IntentionDraft`。

### Step 4：Finalizer 完成两段式流程
- Draft 只是“意图草稿”，还没有引用权重。
- Finalizer 会根据检索结果补齐 references 和 weight。

### Step 5：Interpreter 审查
- Interpreter 根据 YAML 规则做 require/forbid 检查。
- 不通过则 suppressed，通过才进入 Router。

### Step 6：Router 变成 Event
- Router 将 Intention 转为 Event。
- Event 写入 EventStore 并广播回 World。

### Step 7：闭环完成并进入下一轮
- 新 Event 又触发下一轮意向生成。

---

## 3. 数据流细节：从字段角度观察

### 3.1 Event 的流向
```
Event (world) → Controller/Agent 观察 → 触发 IntentionDraft
```
Event 核心字段：
- event_id
- type
- sender
- scope
- content（payload）
- references


### 3.2 Intention 的流向
```
IntentionDraft → Finalizer → Intention → Interpreter → Router → Event
```
Intention 核心字段：
- intention_id
- agent_id
- kind
- payload
- scope
- references
- completed

---

## 4. 数据流“交通管制”机制

### 4.1 规则审查（Interpreter）
- YAML 规则检查必填字段、引用类型、禁用条件等。
- 作用是“防乱说”，保证语义一致。

### 4.2 冷却节流（Router/CooldownGuard）
- 防止 Agent 连续刷屏。
- 同时控制事件之间的时间间隔。

---

## 5. 数据流中的“副通道”

### 5.1 EventStore（持久化）
- 每次 Event 都会落盘到 `events.jsonl`。
- 便于回放与 UI 读取。

### 5.2 Live UI
- Live UI 直接读取 EventStore 数据。
- 只是可视化展示，并不参与主流程。

---

## 6. 数据流的风险点（通俗预警）

1) **字段命名不统一**
- payload vs content 并存，可能导致扩展时搞混。

2) **LLM 输出不稳定**
- 如果 LLM JSON 解析失败，会回退到规则模式。
- 可能导致“时聪明时笨”。

3) **引用权重可能“拍脑袋”**
- weight 三维由 LLM 生成时容易主观化。
- 需要事后评估或多轮校准。

---

## 7. 总结（带点段子）
- 数据流已经形成“流水线式闭环”，像一条自动化工厂产线。
- 但目前工人（LLM）还不够稳定，容易做出“手抖零件”。
- 建议给生产线加质检（评估/校准），让成品更一致。

